<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="Community and Dmitry Rakovets">
<title>Многопоточность</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-K65X7WESXG"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-K65X7WESXG');
</script>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Многопоточность</h1>
<div class="details">
<span id="author" class="author">Community and Dmitry Rakovets</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_расскажите_о_модели_памяти_java">1. Расскажите о модели памяти Java?</a></li>
<li><a href="#_что_такое_потокобезопасность">2. Что такое «потокобезопасность»?</a></li>
<li><a href="#_в_чём_разница_между_конкуренцией_и_параллелизмом">3. В чём разница между <em>«конкуренцией»</em> и <em>«параллелизмом»</em>?</a></li>
<li><a href="#_что_такое_кооперативная_многозадачность_какой_тип_многозадачности_использует_java_чем_обусловлен_этот_выбор">4. Что такое <em>«кооперативная многозадачность»</em>? Какой тип многозадачности использует Java? Чем обусловлен этот выбор?</a></li>
<li><a href="#_что_такое_ordering_as_if_serial_semantics_sequential_consistency_visibility_atomicity_happens_before_mutual_exclusion_safe_publication">5. Что такое <em>ordering</em>, <em>as-if-serial semantics</em>, <em>sequential consistency</em>, <em>visibility</em>, <em>atomicity</em>, <em>happens-before</em>, <em>mutual exclusion</em>, <em>safe publication</em>?</a></li>
<li><a href="#_чем_отличается_процесс_от_потока">6. Чем отличается процесс от потока?</a></li>
<li><a href="#_что_такое_зелёные_потоки_и_есть_ли_они_в_java">7. Что такое <em>«зелёные потоки»</em> и есть ли они в Java?</a></li>
<li><a href="#_каким_образом_можно_создать_поток">8. Каким образом можно создать поток?</a></li>
<li><a href="#_чем_различаются_thread_и_runnable">9. Чем различаются <code>Thread</code> и <code>Runnable</code>?</a></li>
<li><a href="#_в_чём_заключается_разница_между_методами_start_и_run">10. В чём заключается разница между методами <code>start()</code> и <code>run()</code>?</a></li>
<li><a href="#_как_принудительно_запустить_поток">11. Как принудительно запустить поток?</a></li>
<li><a href="#_что_такое_монитор_в_java">12. Что такое <em>«монитор»</em> в Java?</a></li>
<li><a href="#_дайте_определение_понятию_синхронизация">13. Дайте определение понятию «синхронизация».</a></li>
<li><a href="#_какие_существуют_способы_синхронизации_в_java">14. Какие существуют способы синхронизации в Java?</a></li>
<li><a href="#_в_каких_состояниях_может_находиться_поток">15. В каких состояниях может находиться поток?</a></li>
<li><a href="#_можно_ли_создавать_новые_экземпляры_класса_пока_выполняется_static_synchronized_метод">16. Можно ли создавать новые экземпляры класса, пока выполняется <code>static synchronized</code> метод?</a></li>
<li><a href="#_зачем_может_быть_нужен_private_мьютекс">17. Зачем может быть нужен <code>private</code> мьютекс?</a></li>
<li><a href="#_как_работают_методы_wait_и_notifynotifyall">18. Как работают методы <code>wait()</code> и <code>notify()</code>/<code>notifyAll()</code>?</a></li>
<li><a href="#_в_чем_разница_между_notify_и_notifyall">19. В чем разница между <code>notify()</code> и <code>notifyAll()</code>?</a></li>
<li><a href="#_почему_методы_wait_и_notify_вызываются_только_в_синхронизированном_блоке">20. Почему методы <code>wait()</code> и <code>notify()</code> вызываются только в синхронизированном блоке?</a></li>
<li><a href="#_чем_отличается_работа_метода_wait_с_параметром_и_без_параметра">21. Чем отличается работа метода <code>wait()</code> с параметром и без параметра?</a></li>
<li><a href="#_чем_отличаются_методы_thread_sleep_и_thread_yield">22. Чем отличаются методы <code>Thread.sleep()</code> и <code>Thread.yield()</code>?</a></li>
<li><a href="#_как_работает_метод_thread_join">23. Как работает метод <code>Thread.join()</code>?</a></li>
<li><a href="#_что_такое_deadlock">24. Что такое <em>deadlock</em>?</a></li>
<li><a href="#_что_такое_livelock">25. Что такое <em>livelock</em>?</a></li>
<li><a href="#_как_проверить_удерживает_ли_поток_монитор_определённого_ресурса">26. Как проверить, удерживает ли поток монитор определённого ресурса?</a></li>
<li><a href="#_на_каком_объекте_происходит_синхронизация_при_вызове_static_synchronized_метода">27. На каком объекте происходит синхронизация при вызове <code>static synchronized</code> метода?</a></li>
<li><a href="#_для_чего_используется_ключевое_слово_volatile_synchronized_transient_native">28. Для чего используется ключевое слово <code>volatile</code>, <code>synchronized</code>, <code>transient</code>, <code>native</code>?</a></li>
<li><a href="#_в_чём_различия_между_volatile_и_atomic_переменными">29. В чём различия между <code>volatile</code> и <em>Atomic</em> переменными?</a></li>
<li><a href="#_в_чём_заключаются_различия_между_java_util_concurrent_atomic_compareandswap_и_java_util_concurrent_atomic_weakcompareandswap">30. В чём заключаются различия между <code>java.util.concurrent.Atomic*.compareAndSwap()</code> и <code>java.util.concurrent.Atomic*.weakCompareAndSwap()</code>.</a></li>
<li><a href="#_что_значит_приоритет_потока">31. Что значит <em>«приоритет потока»</em>?</a></li>
<li><a href="#_что_такое_потоки_демоны">32. Что такое <em>«потоки-демоны»</em>?</a></li>
<li><a href="#_можно_ли_сделать_основной_поток_программы_демоном">33. Можно ли сделать основной поток программы демоном?</a></li>
<li><a href="#_что_значит_усыпить_поток">34. Что значит <em>«усыпить»</em> поток?</a></li>
<li><a href="#_чем_отличаются_два_интерфейса_runnable_и_callable">35. Чем отличаются два интерфейса <code>Runnable</code> и <code>Callable</code>?</a></li>
<li><a href="#_что_такое_futuretask">36. Что такое <code>FutureTask</code>?</a></li>
<li><a href="#_в_чем_заключаются_различия_между_cyclicbarrier_и_countdownlatch">37. В чем заключаются различия между <code>CyclicBarrier</code> и <code>CountDownLatch</code>?</a></li>
<li><a href="#_что_такое_race_condition">38. Что такое <em>race condition</em>?</a></li>
<li><a href="#_существует_ли_способ_решения_проблемы_race_condition">39. Существует ли способ решения проблемы <em>race condition</em>?</a></li>
<li><a href="#_как_остановить_поток">40. Как остановить поток?</a></li>
<li><a href="#_почему_не_рекомендуется_использовать_метод_thread_stop">41. Почему не рекомендуется использовать метод <code>Thread.stop()</code>?</a></li>
<li><a href="#_что_происходит_когда_в_потоке_выбрасывается_исключение">42. Что происходит, когда в потоке выбрасывается исключение?</a></li>
<li><a href="#_в_чем_разница_между_interrupted_и_isinterrupted">43. В чем разница между <code>interrupted()</code> и <code>isInterrupted()</code>?</a></li>
<li><a href="#_что_такое_пул_потоков">44. Что такое <em>«пул потоков»</em>?</a></li>
<li><a href="#_какого_размера_должен_быть_пул_потоков">45. Какого размера должен быть пул потоков?</a></li>
<li><a href="#_что_будет_если_очередь_пула_потоков_уже_заполнена_но_подаётся_новая_задача">46. Что будет, если очередь пула потоков уже заполнена, но подаётся новая задача?</a></li>
<li><a href="#_в_чём_заключается_различие_между_методами_submit_и_execute_у_пула_потоков">47. В чём заключается различие между методами <code>submit()</code> и <code>execute()</code> у пула потоков?</a></li>
<li><a href="#_в_чем_заключаются_различия_между_cтеком_stack_и_кучей_heap_с_точки_зрения_многопоточности">48. В чем заключаются различия между cтеком (stack) и кучей (heap) с точки зрения многопоточности?</a></li>
<li><a href="#_как_поделиться_данными_между_двумя_потоками">49. Как поделиться данными между двумя потоками?</a></li>
<li><a href="#_какой_параметр_запуска_jvm_используется_для_контроля_размера_стека_потока">50. Какой параметр запуска JVM используется для контроля размера стека потока?</a></li>
<li><a href="#_как_получить_дамп_потока">51. Как получить дамп потока?</a></li>
<li><a href="#_что_такое_threadlocal_переменная">52. Что такое <em>ThreadLocal-переменная</em>?</a></li>
<li><a href="#_назовите_различия_между_synchronized_и_reentrantlock">53. Назовите различия между <code>synchronized</code> и <code>ReentrantLock</code>?</a></li>
<li><a href="#_что_такое_readwritelock">54. Что такое <code>ReadWriteLock</code>?</a></li>
<li><a href="#_что_такое_блокирующий_метод">55. Что такое <em>«блокирующий метод»</em>?</a></li>
<li><a href="#_что_такое_фреймворк_forkjoin">56. Что такое <em>«фреймворк Fork/Join»</em>?</a></li>
<li><a href="#_что_такое_semaphore">57. Что такое <code>Semaphore</code>?</a></li>
<li><a href="#_что_такое_double_checked_locking_singleton">58. Что такое <em>double checked locking Singleton</em>?</a></li>
<li><a href="#_как_создать_потокобезопасный_singleton">59. Как создать потокобезопасный Singleton?</a></li>
<li><a href="#_чем_полезны_неизменяемые_объекты">60. Чем полезны неизменяемые объекты?</a></li>
<li><a href="#_что_такое_busy_spin">61. Что такое <em>busy spin</em>?</a></li>
<li><a href="#_перечислите_принципы_которым_вы_следуете_в_многопоточном_программировании">62. Перечислите принципы, которым вы следуете в многопоточном программировании?</a></li>
<li><a href="#_какое_из_следующих_утверждений_о_потоках_неверно">63. Какое из следующих утверждений о потоках неверно?</a></li>
<li><a href="#_даны_3_потока_т1_т2_и_т3_как_реализовать_выполнение_в_последовательности_т1_т2_т3">64. Даны 3 потока Т1, Т2 и Т3? Как реализовать выполнение в последовательности Т1, Т2, Т3?</a></li>
<li><a href="#_напишите_минимальный_неблокирующий_стек_всего_два_метода_push_и_pop">65. Напишите минимальный неблокирующий стек (всего два метода — <code>push()</code> и <code>pop()</code>).</a></li>
<li><a href="#_напишите_минимальный_неблокирующий_стек_всего_два_метода_push_и_pop_с_использованием_semaphore">66. Напишите минимальный неблокирующий стек (всего два метода — <code>push()</code> и <code>pop()</code>) с использованием <code>Semaphore</code>.</a></li>
<li><a href="#_напишите_минимальный_неблокирующий_arraylist_всего_четыре_метода_add_get_remove_size">67. Напишите минимальный неблокирующий ArrayList (всего четыре метода — <code>add()</code>, <code>get()</code>, <code>remove()</code>, <code>size()</code>).</a></li>
<li><a href="#_напишите_потокобезопасную_реализацию_класса_с_неблокирующим_методом_biginteger_next_который_возвращает_элементы_последовательности_1_2_4_8_16">68. Напишите потокобезопасную реализацию класса с неблокирующим методом <code>BigInteger next()</code>, который возвращает элементы последовательности: <code>[1, 2, 4, 8, 16, &#8230;&#8203;]</code>.</a></li>
<li><a href="#_напишите_простейший_многопоточный_ограниченный_буфер_с_использованием_synchronized">69. Напишите простейший многопоточный ограниченный буфер с использованием <code>synchronized</code>.</a></li>
<li><a href="#_напишите_простейший_многопоточный_ограниченный_буфер_с_использованием_reentrantlock">70. Напишите простейший многопоточный ограниченный буфер с использованием <code>ReentrantLock</code>.</a></li>
<li><a href="#_источники">71. Источники</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="./">Вопросы для собеседования</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_расскажите_о_модели_памяти_java">1. Расскажите о модели памяти Java?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Модель памяти Java (Java Memory Model, JMM)</strong> описывает поведение потоков в среде исполнения Java. Это часть семантики языка Java, набор правил, описывающий выполнение многопоточных программ и правил, по которым потоки могут взаимодействовать друг с другом посредством основной памяти.</p>
</div>
<div class="paragraph">
<p>Формально модель памяти определяет набор действий межпоточного взаимодействия (эти действия включают в себя, в частности, чтение и запись переменной, захват и освобождений монитора, чтение и запись volatile переменной, запуск нового потока), а также модель памяти определяет отношение между этими действиями -<em>happens-before</em> - абстракции обозначающей, что если операция <em>X</em> связана отношением happens-before с операцией <em>Y</em>, то весь код следуемый за операцией <em>Y</em>, выполняемый в одном потоке, видит все изменения, сделанные другим потоком, до операции <em>X</em>.</p>
</div>
<div class="paragraph">
<p>Существует несколько основных правил для отношения happens-before:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>В рамках одного потока любая операция happens-before любой операцией, следующей за ней в исходном коде;</p>
</li>
<li>
<p>Освобождение монитора (unlock) happens-before захват того же монитора (lock);</p>
</li>
<li>
<p>Выход из <code>synchronized</code> блока/метода happens-before вход в <code>synchronized</code> блок/метод на том же мониторе;</p>
</li>
<li>
<p>Запись <code>volatile</code> поля happens-before чтение того же самого <code>volatile</code> поля;</p>
</li>
<li>
<p>Завершение метода <code>run()</code> экземпляра класса <code>Thread</code> happens-before выход из метода <code>join()</code> или возвращение <code>false</code> методом <code>isAlive()</code> экземпляром того же потока;</p>
</li>
<li>
<p>Вызов метода <code>start()</code> экземпляра класса <code>Thread</code> happens-before начало метода <code>run()</code> экземпляра того же потока;</p>
</li>
<li>
<p>Завершение конструктора happens-before начало метода <code>finalize()</code> этого класса;</p>
</li>
<li>
<p>Вызов метода <code>interrupt()</code> на потоке happens-before обнаружению потоком факта, что данный метод был вызван либо путем выбрасывания исключения <code>InterruptedException</code>, либо с помощью методов <code>isInterrupted()</code> или <code>interrupted()</code>.</p>
</li>
<li>
<p>Связь happens-before транзитивна, т.е. если <em>X</em> happens-before <em>Y</em>, а <em>Y</em> happens-before <em>Z</em>, то <em>X</em> happens-before <em>Z</em>.</p>
</li>
<li>
<p>Освобождение/захват монитора и запись/чтение в <code>volatile</code> переменную связаны отношением happens-before, только если операции проводятся над одним и тем же экземпляром объекта.</p>
</li>
<li>
<p>В отношении happens-before участвуют только два потока, о поведении остальных потоков ничего сказать нельзя, пока в каждом из них не наступит отношение happens-before с другим потоком.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Можно выделить несколько основных областей, имеющих отношение к модели памяти:</p>
</div>
<div class="paragraph">
<p><em>Видимость (visibility)</em>. Один поток может в какой-то момент временно сохранить значение некоторых полей не в основную память, а в регистры или локальный кэш процессора, таким образом второй поток, выполняемый на другом процессоре, читая из основной памяти, может не увидеть последних изменений поля. И наоборот, если поток на протяжении какого-то времени работает с регистрами и локальными кэшами, читая данные оттуда, он может сразу не увидеть изменений, сделанных другим потоком в основную память.</p>
</div>
<div class="paragraph">
<p>К вопросу видимости имеют отношение следующие ключевые слов языка Java: <code>synchronized</code>, <code>volatile</code>, <code>final</code>.</p>
</div>
<div class="paragraph">
<p>С точки зрения Java все переменные (за исключением локальных переменных, объявленных внутри метода) хранятся в главной памяти, которая доступна всем потокам, кроме этого, каждый поток имеет локальную—рабочую—память, где он хранит копии переменных, с которыми он работает, и при выполнении программы поток работает только с этими копиями. Надо отметить, что это описание не требование к реализации, а всего лишь модель, которая объясняет поведение программы, так, в качестве локальной памяти не обязательно выступает кэш память, это могут быть регистры процессора или потоки могут вообще не иметь локальной памяти.</p>
</div>
<div class="paragraph">
<p>При входе в <code>synchronized</code> метод или блок поток обновляет содержимое локальной памяти, а при выходе из <code>synchronized</code> метода или блока поток записывает изменения, сделанные в локальной памяти, в главную. Такое поведение <code>synchronized</code> методов и блоков следует из правил для отношения «происходит раньше»: так как все операции с памятью происходят раньше освобождения монитора и освобождение монитора происходит раньше захвата монитора, то все операции с памятью, которые были сделаны потоком до выхода из <code>synchronized</code> блока должны быть видны любому потоку, который входит в <code>synchronized</code> блок для того же самого монитора. Очень важно, что это правило работает только в том случае, если потоки синхронизируются, используя один и тот же монитор!</p>
</div>
<div class="paragraph">
<p>Что касается <code>volatile</code> переменных, то запись таких переменных производится в основную память, минуя локальную. и чтение <code>volatile</code> переменной производится также из основной памяти, то есть значение переменной не может сохраняться в регистрах или локальной памяти потока и операция чтения этой переменной гарантированно вернёт последнее записанное в неё значение.</p>
</div>
<div class="paragraph">
<p>Также модель памяти определяет дополнительную семантику ключевого слова <code>final</code>, имеющую отношение к видимости: после того как объект был корректно создан, любой поток может видеть значения его <code>final</code> полей без дополнительной синхронизации. «Корректно создан» означает, что ссылка на создающийся объект не должна использоваться до тех пор, пока не завершился конструктор объекта. Наличие такой семантики для ключевого слова <code>final</code> позволяет создание неизменяемых (immutable) объектов, содержащих только <code>final</code> поля, такие объекты могут свободно передаваться между потоками без обеспечения синхронизации при передаче.</p>
</div>
<div class="paragraph">
<p>Есть одна проблема, связанная с <code>final</code> полями: реализация разрешает менять значения таких полей после создания объекта (это может быть сделано, например, с использованием механизма reflection). Если значение <code>final</code> поля—константа, чьё значение известно на момент компиляции, изменения такого поля могут не иметь эффекта, так-как обращения к этой переменной могли быть заменены компилятором на константу. Также спецификация разрешает другие оптимизации, связанные с <code>final</code> полями, например, операции чтения <code>final</code> переменной могут быть переупорядочены с операциями, которые потенциально могут изменить такую переменную. Так что рекомендуется изменять <code>final</code> поля объекта только внутри конструктора, в противном случае поведение не специфицировано.</p>
</div>
<div class="paragraph">
<p><em>Reordering (переупорядочивание)</em>. Для увеличения производительности процессор/компилятор могут переставлять местами некоторые инструкции/операции. Вернее, с точки зрения потока, наблюдающего за выполнением операций в другом потоке, операции могут быть выполнены не в том порядке, в котором они идут в исходном коде. Тот же эффект может наблюдаться, когда один поток кладет результаты первой операции в регистр или локальный кэш, а результат второй операции попадает непосредственно в основную память. Тогда второй поток, обращаясь к основной памяти может сначала увидеть результат второй операции, и только потом первой, когда все регистры или кэши синхронизируются с основной памятью. Еще одна причина reordering, может заключаться в том, что процессор может решить поменять порядок выполнения операций, если, например, сочтет что такая последовательность выполнится быстрее.</p>
</div>
<div class="paragraph">
<p>Вопрос reordering также регулируется набором правил для отношения «происходит раньше» и у этих правил есть следствие, касающееся порядка операций, используемое на практике: операции чтения и записи <code>volatile</code> переменных не могут быть переупорядочены с операциями чтения и записи других <code>volatile</code> и не-<code>volatile</code> переменных. Это следствие делает возможным использование <code>volatile</code> переменной как флага, сигнализирующем об окончании какого-либо действия. В остальном правила, касающиеся порядка выполнения операций, гарантируют упорядоченность операций для конкретного набора случаев (таких как, например, захват и освобождение монитора), во всех остальных случаях оставляя компилятору и процессору полную свободу для оптимизаций.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_потокобезопасность">2. Что такое «потокобезопасность»?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Потокобезопасность – свойство объекта или кода, которое гарантирует, что при исполнении или использовании несколькими потоками, код будет вести себя, как предполагается. Например потокобезопасный счётчик не пропустит ни один счёт, даже если один и тот же экземпляр этого счётчика будет использоваться несколькими потоками.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_в_чём_разница_между_конкуренцией_и_параллелизмом">3. В чём разница между <em>«конкуренцией»</em> и <em>«параллелизмом»</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Конкуренция — это способ одновременного решения множества задач.</p>
</div>
<div class="paragraph">
<p>Признаки:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Наличие нескольких потоков управления (например, <em>Thread</em> в Java, <em>корутина</em> в Kotlin), если поток управления один, то конкурентного выполнения быть не может</p>
</li>
<li>
<p>Недетерминированный результат выполнения. Результат зависит от случайных событий, реализации и того, как была проведена синхронизация. Даже если каждый поток полностью детерминированный, итоговый результат будет недетерминированным</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Параллелизм — это способ выполнения разных частей одной задачи.</p>
</div>
<div class="paragraph">
<p>Признаки:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Необязательно имеет несколько потоков управления</p>
</li>
<li>
<p>Может приводить к детерминированному результату, так, например, результат умножения каждого элемента массива на число, не изменится, если умножать его по частям параллельно.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_кооперативная_многозадачность_какой_тип_многозадачности_использует_java_чем_обусловлен_этот_выбор">4. Что такое <em>«кооперативная многозадачность»</em>? Какой тип многозадачности использует Java? Чем обусловлен этот выбор?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Кооперативная многозадачность</strong> - это способ деления процессорного времени между потоками, при котором каждый поток обязан отдавать управление следующему добровольно.</p>
</div>
<div class="paragraph">
<p>Преимущества такого подхода - простота реализации, меньшие накладные расходы на переключение контекста.</p>
</div>
<div class="paragraph">
<p>Недостатки - если один поток завис или ведет себя некорректно, то зависает целиком вся система и другие потоки никогда не получат управление.</p>
</div>
<div class="paragraph">
<p>Java использует <strong>вытесняющую многозадачность</strong>, при которой решение о переключении между потоками процесса принимает операционная система.</p>
</div>
<div class="paragraph">
<p>В отличие от кооперативной многозадачности управление операционной системе передаётся вне зависимости от состояния работающих приложений, благодаря чему, отдельные зависшие потоки процесса, как правило, не «подвешивают» всю систему целиком. За счёт регулярного переключения между задачами также улучшается отзывчивость приложения и повышается оперативность освобождения ресурсов, которые больше не используются.</p>
</div>
<div class="paragraph">
<p>В реализации вытесняющая многозадачность отличается от кооперативной, в частности, тем, что требует обработки системного прерывания от аппаратного таймера.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_ordering_as_if_serial_semantics_sequential_consistency_visibility_atomicity_happens_before_mutual_exclusion_safe_publication">5. Что такое <em>ordering</em>, <em>as-if-serial semantics</em>, <em>sequential consistency</em>, <em>visibility</em>, <em>atomicity</em>, <em>happens-before</em>, <em>mutual exclusion</em>, <em>safe publication</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>ordering</strong> механизм, который определяет, когда один поток может увидеть <em>out-of-order</em> (неверный) порядок исполнения инструкций другого потока. CPU для повышения производительности может переупорядочивать процессорные инструкции и выполнять их в произвольном порядке до тех пор пока для потока внутри не будет видно никаких отличий. Гарантия, предоставляемая этим механизмом, называется <strong>as-if-serial semantics</strong>.</p>
</div>
<div class="paragraph">
<p><strong>sequential consistency</strong> - то же что и <em>as-if-serial semantics</em>, гарантия того, что в рамках одного потока побочные эффекты от всех операций будут такие, как будто все операции выполняются последовательно.</p>
</div>
<div class="paragraph">
<p><strong>visibility</strong> определяет, когда действия в одном потоке становятся видны из другого потока.</p>
</div>
<div class="paragraph">
<p><strong>happens-before</strong> - логическое ограничение на порядок выполнения инструкций программы. Если указывается, что запись в переменную и последующее ее чтение связаны через эту зависимость, то как бы при выполнении не переупорядочивались инструкции, в момент чтения все связанные с процессом записи результаты уже зафиксированы и видны.</p>
</div>
<div class="paragraph">
<p><strong>atomicity</strong> — атомарность операций. Атомарная операция выглядит единой и неделимой командой процессора, которая может быть или уже выполненной или ещё невыполненной.</p>
</div>
<div class="paragraph">
<p><strong>mutual exclusion</strong> (взаимоисключающая блокировка, семафор с одним состоянием) - механизм, гарантирующий потоку исключительный доступ к ресурсу. Используется для предотвращения одновременного доступа к общему ресурсу. В каждый момент времени таким ресурсом может владеть только один поток. Простейший пример: <code>synchronized(obj) { … }</code>.</p>
</div>
<div class="paragraph">
<p><strong>safe publication</strong>? - показ объектов другим потокам из текущего, не нарушая ограничений <em>visibility</em>. Способы такой публикации в Java:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>static{}</code> инициализатор;</p>
</li>
<li>
<p><code>volatile</code> переменные;</p>
</li>
<li>
<p><code>atomic</code> переменные;</p>
</li>
<li>
<p>сохранение в разделяемой переменной, корректно защищенной с использованием <code>synchronized()</code>, синхронизаторов или других конструкций, создающих <em>read/write memory barrier</em>;</p>
</li>
<li>
<p><code>final</code> переменные в разделяемом объекте, который был корректно проинициализирован.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_чем_отличается_процесс_от_потока">6. Чем отличается процесс от потока?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Процесс</strong> — экземпляр программы во время выполнения, независимый объект, которому выделены системные ресурсы (например, процессорное время и память). Каждый процесс выполняется в отдельном адресном пространстве: один процесс не может получить доступ к переменным и структурам данных другого. Если процесс хочет получить доступ к чужим ресурсам, необходимо использовать межпроцессное взаимодействие. Это могут быть конвейеры, файлы, каналы связи между компьютерами и многое другое.</p>
</div>
<div class="paragraph">
<p>Для каждого процесса ОС создает так называемое «виртуальное адресное пространство», к которому процесс имеет прямой доступ. Это пространство принадлежит процессу, содержит только его данные и находится в полном его распоряжении. Операционная система же отвечает за то, как виртуальное пространство процесса проецируется на физическую память.</p>
</div>
<div class="paragraph">
<p><strong>Поток</strong>(thread) — определенный способ выполнения процесса, определяющий последовательность исполнения кода в процессе. Потоки всегда создаются в контексте какого-либо процесса, и вся их жизнь проходит только в его границах.
Потоки могут исполнять один и тот же код и манипулировать одними и теми же данными, а также совместно использовать описатели объектов ядра, поскольку таблица описателей создается не в отдельных потоках, а в процессах.
Так как потоки расходуют существенно меньше ресурсов, чем процессы, в процессе выполнения работы выгоднее создавать дополнительные потоки и избегать создания новых процессов.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_зелёные_потоки_и_есть_ли_они_в_java">7. Что такое <em>«зелёные потоки»</em> и есть ли они в Java?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Зелёные (легковесные) потоки</strong>(green threads) - потоки эмулируемые виртуальной машиной или средой исполнения. Создание зелёного потока не подразумевает под собой создание реального потока ОС.</p>
</div>
<div class="paragraph">
<p>Виртуальная машина Java берёт на себя заботу о переключении между разными green threads, а сама машина работает как один поток ОС. Это даёт несколько преимуществ. Потоки ОС относительно дороги в большинстве POSIX-систем. Кроме того, переключение между native threads гораздо медленнее, чем между green threads.</p>
</div>
<div class="paragraph">
<p>Это всё означает, что в некоторых ситуациях green threads гораздо выгоднее, чем native threads. Система может поддерживать гораздо большее количество green threads, чем потоков OС. Например, гораздо практичнее запускать новый green thread для нового HTTP-соединения к веб-серверу, вместо создания нового native thread.</p>
</div>
<div class="paragraph">
<p>Однако есть и недостатки. Самый большой заключается в том, что вы не можете исполнять два потока одновременно. Поскольку существует только один native thread, только он и вызывается планировщиком ОС. Даже если у вас несколько процессоров и несколько green threads, только один процессор может вызывать green thread. И всё потому, что с точки зрения планировщика заданий ОС всё это выглядит одним потоком.</p>
</div>
<div class="paragraph">
<p>Начиная с версии 1.2 Java поддерживает native threads, и с тех пор они используются по умолчанию.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_каким_образом_можно_создать_поток">8. Каким образом можно создать поток?</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Создать потомка класса <code>Thread</code> и переопределить его метод <code>run()</code>;</p>
</li>
<li>
<p>Создать объект класса <code>Thread</code>, передав ему в конструкторе экземпляр класса, реализующего интерфейс <code>Runnable</code>. Эти интерфейс содержит метод <code>run()</code>, который будет выполняться в новом потоке. Поток закончит выполнение, когда завершится его метод <code>run()</code>.</p>
</li>
<li>
<p>Вызвать метод <code>submit()</code> у экземпляра класса реализующего интерфейс <code>ExecutorService</code>, передав ему в качестве параметра экземпляр класса реализующего интерфейс <code>Runnable</code> или <code>Callable</code> (содержит метод <code>call()</code>, в котором описывается логика выполнения).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_чем_различаются_thread_и_runnable">9. Чем различаются <code>Thread</code> и <code>Runnable</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>Thread</code> - это класс, некоторая надстройка над физическим потоком.</p>
</div>
<div class="paragraph">
<p><code>Runnable</code> - это интерфейс, представляющий абстракцию над выполняемой задачей.</p>
</div>
<div class="paragraph">
<p>Помимо того, что <code>Runnable</code> помогает разрешить проблему множественного наследования, несомненный плюс от его использования состоит в том, что он позволяет логически отделить логику выполнения задачи от непосредственного управления потоком.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_в_чём_заключается_разница_между_методами_start_и_run">10. В чём заключается разница между методами <code>start()</code> и <code>run()</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Несмотря на то, что <code>start()</code> вызывает метод <code>run()</code> внутри себя, это не то же самое, что просто вызов <code>run()</code>. Если <code>run()</code> вызывается как обычный метод, то он вызывается в том же потоке и никакой новый поток не запускается, как это происходит, в случае, когда вы вызываете метод <code>start()</code>.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_как_принудительно_запустить_поток">11. Как принудительно запустить поток?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Никак. В Java не существует абсолютно никакого способа принудительного запуска потока. Это контролируется JVM и Java не предоставляет никакого API для управления этим процессом.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_монитор_в_java">12. Что такое <em>«монитор»</em> в Java?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Монитор</strong>, мьютекс (mutex) – это средство обеспечения контроля за доступом к ресурсу. У монитора может быть максимум один владелец в каждый текущий момент времени. Следовательно, если кто-то использует ресурс и захватил монитор для обеспечения единоличного доступа, то другой, желающий использовать тот же ресурс, должен подождать освобождения монитора, захватить его и только потом начать использовать ресурс.</p>
</div>
<div class="paragraph">
<p>Удобно представлять монитор как id захватившего его объекта. Если этот id равен 0 – ресурс свободен. Если не 0 – ресурс занят. Можно встать в очередь и ждать его освобождения.</p>
</div>
<div class="paragraph">
<p>В Java у каждого экземпляра объекта есть монитор, который контролируется непосредственно виртуальной машиной. Используется он так: любой нестатический <code>synchronized</code>-метод при своем вызове прежде всего пытается захватить монитор того объекта, у которого он вызван (на который он может сослаться как на <code>this</code>). Если это удалось – метод исполняется. Если нет – поток останавливается и ждет, пока монитор будет отпущен.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_дайте_определение_понятию_синхронизация">13. Дайте определение понятию «синхронизация».</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Синхронизация - это процесс, который позволяет выполнять потоки параллельно.</p>
</div>
<div class="paragraph">
<p>В Java все объекты имеют одну блокировку, благодаря которой только один поток одновременно может получить доступ к критическому коду в объекте. Такая синхронизация помогает предотвратить повреждение состояния объекта. Если поток получил блокировку, ни один другой поток не может войти в синхронизированный код, пока блокировка не будет снята. Когда поток, владеющий блокировкой, выходит из синхронизированного кода, блокировка снимается. Теперь другой поток может получить блокировку объекта и выполнить синхронизированный код. Если поток пытается получить блокировку объекта, когда другой поток владеет блокировкой, поток переходит в состояние Блокировки до тех пор, пока блокировка не снимется.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_какие_существуют_способы_синхронизации_в_java">14. Какие существуют способы синхронизации в Java?</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><strong>Системная синхронизация с использованием <code>wait()</code>/<code>notify()</code></strong>. Поток, который ждет выполнения каких-либо условий, вызывает у этого объекта метод <code>wait()</code>, предварительно захватив его монитор. На этом его работа приостанавливается. Другой поток может вызвать на этом же самом объекте метод <code>notify()</code> (опять же, предварительно захватив монитор объекта), в результате чего, ждущий на объекте поток «просыпается» и продолжает свое выполнение. В обоих случаях монитор надо захватывать в явном виде, через <code>synchronized</code>-блок, потому как методы <code>wait()</code>/<code>notify()</code> не синхронизированы!</p>
</li>
<li>
<p><strong>Системная синхронизация с использованием <code>join()</code></strong>. Метод <code>join()</code>, вызванный у экземпляра класса <code>Thread</code>, позволяет текущему потоку остановиться до того момента, как поток, связанный с этим экземпляром, закончит работу.</p>
</li>
<li>
<p><strong>Использование классов из пакета <code>java.util.concurrent</code></strong>, который предоставляет набор классов для организации межпоточного взаимодействия. Примеры таких классов - <code>Lock</code>, <code>Semaphore</code> и пр.. Концепция данного подхода заключается в использовании атомарных операций и переменных.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_в_каких_состояниях_может_находиться_поток">15. В каких состояниях может находиться поток?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Потоки могут находиться в одном из следующих состояний:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Новый (New)</strong>. После создания экземпляра потока, он находится в состоянии Новый до тех пор, пока не вызван метод <code>start()</code>. В этом состоянии поток не считается живым.</p>
</li>
<li>
<p><strong>Работоспособный (Runnable)</strong>. Поток переходит в состояние Работоспособный, когда вызывается метод <code>start()</code>. Поток может перейти в это состояние также из состояния Работающий или из состояния Блокирован. Когда поток находится в этом состоянии, он считается живым.</p>
</li>
<li>
<p><strong>Работающий (Running)</strong>. Поток переходит из состояния Работоспособный в состояние Работающий, когда Планировщик потоков выбирает его как работающий в данный момент.</p>
</li>
<li>
<p><strong>Живой, но не работоспособный (Alive, but not runnable)</strong>. Поток может быть живым, но не работоспособным по нескольким причинам:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Ожидание (Waiting)</strong>. Поток переходит в состояние Ожидания, вызывая метод <code>wait()</code>. Вызов <code>notify()</code> или <code>notifyAll()</code> может перевести поток из состояния Ожидания в состояние Работоспособный.</p>
</li>
<li>
<p><strong>Сон (Sleeping)</strong>. Метод <code>sleep()</code> переводит поток в состояние Сна на заданный промежуток времени в миллисекундах.</p>
</li>
<li>
<p><strong>Блокировка (Blocked)</strong>. Поток может перейти в это состояние, в ожидании ресурса, такого как ввод/вывод или из-за блокировки другого объекта. В этом случае поток переходит в состояние Работоспособный, когда ресурс становится доступен.</p>
</li>
<li>
<p><strong>Мёртвый (Dead)</strong>. Поток считается мёртвым, когда его метод <code>run()</code> полностью выполнен. Мёртвый поток не может перейти ни в какое другое состояние, даже если для него вызван метод <code>start()</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_можно_ли_создавать_новые_экземпляры_класса_пока_выполняется_static_synchronized_метод">16. Можно ли создавать новые экземпляры класса, пока выполняется <code>static synchronized</code> метод?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Да, можно создавать новые экземпляры класса, так как статические поля не принадлежат к экземплярам класса.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_зачем_может_быть_нужен_private_мьютекс">17. Зачем может быть нужен <code>private</code> мьютекс?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Объект для синхронизации делается <code>private</code>, чтобы сторонний код не мог на него синхронизироваться и случайно получить взаимную блокировку.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_как_работают_методы_wait_и_notifynotifyall">18. Как работают методы <code>wait()</code> и <code>notify()</code>/<code>notifyAll()</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Эти методы определены у класса <code>Object</code> и предназначены для взаимодействия потоков между собой при межпоточной синхронизации.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>wait()</code>: освобождает монитор и переводит вызывающий поток в состояние ожидания до тех пор, пока другой поток не вызовет метод <code>notify()</code>/<code>notifyAll()</code>;</p>
</li>
<li>
<p><code>notify()</code>: продолжает работу потока, у которого ранее был вызван метод <code>wait()</code>;</p>
</li>
<li>
<p><code>notifyAll()</code>: возобновляет работу всех потоков, у которых ранее был вызван метод <code>wait()</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Когда вызван метод <code>wait()</code>, поток освобождает блокировку на объекте и переходит из состояния Работающий (Running) в состояние Ожидания (Waiting). Метод <code>notify()</code> подаёт сигнал одному из потоков, ожидающих на объекте, чтобы перейти в состояние Работоспособный (Runnable). При этом невозможно определить, какой из ожидающих потоков должен стать работоспособным. Метод <code>notifyAll()</code> заставляет все ожидающие потоки для объекта вернуться в состояние Работоспособный (Runnable). Если ни один поток не находится в ожидании на методе <code>wait()</code>, то при вызове <code>notify()</code> или <code>notifyAll()</code> ничего не происходит.</p>
</div>
<div class="paragraph">
<p>Поток может вызвать методы <code>wait()</code> или <code>notify()</code> для определённого объекта, только если он в данный момент имеет блокировку на этот объект. <code>wait()</code>, <code>notify()</code> и <code>notifyAll()</code> должны вызываться только из синхронизированного кода.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_в_чем_разница_между_notify_и_notifyall">19. В чем разница между <code>notify()</code> и <code>notifyAll()</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Дело в том, что «висеть» на методе <code>wait()</code> одного монитора могут сразу несколько потоков. При вызове <code>notify()</code> только один из них выходит из <code>wait()</code> и пытается захватить монитор, а затем продолжает работу со следующего после <code>wait()</code> оператора. Какой из них выйдет - заранее неизвестно. А при вызове <code>notifyAll()</code>, все висящие на <code>wait()</code> потоки выходят из <code>wait()</code>, и все они пытаются захватить монитор. Понятно, что в любой момент времени монитор может быть захвачен только одним потоком, а остальные ждут своей очереди. Порядок очереди определяется планировщиком потоков Java.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_почему_методы_wait_и_notify_вызываются_только_в_синхронизированном_блоке">20. Почему методы <code>wait()</code> и <code>notify()</code> вызываются только в синхронизированном блоке?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Монитор надо захватывать в явном виде (через <code>synchronized</code>-блок), потому что методы <code>wait()</code> и <code>notify()</code> не синхронизированы.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_чем_отличается_работа_метода_wait_с_параметром_и_без_параметра">21. Чем отличается работа метода <code>wait()</code> с параметром и без параметра?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>wait()</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>без параметров</strong> освобождает монитор и переводит вызывающий поток в состояние ожидания до тех пор, пока другой поток не вызовет метод <code>notify()</code>/<code>notifyAll()</code>,</p>
</li>
<li>
<p><strong>с параметрами</strong> заставит поток ожидать заданное количество времени или вызова <code>notify()</code>/<code>notifyAll()</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_чем_отличаются_методы_thread_sleep_и_thread_yield">22. Чем отличаются методы <code>Thread.sleep()</code> и <code>Thread.yield()</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Метод <code>yield()</code> служит причиной того, что поток переходит из состояния работающий (running) в состояние работоспособный (runnable), давая возможность другим потокам активизироваться. Но следующий выбранный для запуска поток может и не быть другим.</p>
</div>
<div class="paragraph">
<p>Метод <code>sleep()</code> вызывает засыпание текущего потока на заданное время, состояние изменяется с работающий (running) на ожидающий (waiting).</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_как_работает_метод_thread_join">23. Как работает метод <code>Thread.join()</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Когда поток вызывает <code>join()</code> для другого потока, текущий работающий поток будет ждать, пока другой поток, к которому он присоединяется, не будет завершён:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">void</span> <span class="nf">join</span><span class="o">()</span>
<span class="kt">void</span> <span class="nf">join</span><span class="o">(</span><span class="kt">long</span> <span class="n">millis</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">join</span><span class="o">(</span><span class="kt">long</span> <span class="n">millis</span><span class="o">,</span> <span class="kt">int</span> <span class="n">nanos</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_deadlock">24. Что такое <em>deadlock</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Взаимная блокировка (deadlock)</strong> - явление, при котором все потоки находятся в режиме ожидания. Происходит, когда достигаются состояния:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>взаимного исключения: по крайней мере один ресурс занят в режиме неделимости и, следовательно, только один поток может использовать ресурс в любой данный момент времени.</p>
</li>
<li>
<p>удержания и ожидания: поток удерживает как минимум один ресурс и запрашивает дополнительные ресурсов, которые удерживаются другими потоками.</p>
</li>
<li>
<p>отсутствия предочистки: операционная система не переназначивает ресурсы: если они уже заняты, они должны отдаваться удерживающим потокам сразу же.</p>
</li>
<li>
<p>цикличного ожидания: поток ждёт освобождения ресурса, другим потоком, который в свою очередь ждёт освобождения ресурса заблокированного первым потоком.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Простейший способ избежать взаимной блокировки – не допускать цикличного ожидания. Этого можно достичь, получая мониторы разделяемых ресурсов в определённом порядке и освобождая их в обратном порядке.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_livelock">25. Что такое <em>livelock</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>livelock</em> – тип взаимной блокировки, при котором несколько потоков выполняют бесполезную работу, попадая в зацикленность при попытке получения каких-либо ресурсов. При этом их состояния постоянно изменяются в зависимости друг от друга. Фактической ошибки не возникает, но КПД системы падает до 0. Часто возникает в результате попыток предотвращения deadlock.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Реальный пример livelock, – когда два человека встречаются в узком коридоре и каждый, пытаясь быть вежливым, отходит в сторону, и так они бесконечно двигаются из стороны в сторону, абсолютно не продвигаясь в нужном им направлении.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_как_проверить_удерживает_ли_поток_монитор_определённого_ресурса">26. Как проверить, удерживает ли поток монитор определённого ресурса?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Метод <code>Thread.holdsLock(lock)</code> возвращает <code>true</code>, когда текущий поток удерживает монитор у определённого объекта.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_на_каком_объекте_происходит_синхронизация_при_вызове_static_synchronized_метода">27. На каком объекте происходит синхронизация при вызове <code>static synchronized</code> метода?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>У синхронизированного статического метода нет доступа к <code>this</code>, но есть доступ к объекту класса <code>Class</code>, он присутствует в единственном экземпляре и именно он выступает в качестве монитора для синхронизации статических методов. Таким образом, следующая конструкция:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SomeClass</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">someMethod</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//code</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>эквивалентна такой:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SomeClass</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">someMethod</span><span class="o">(){</span>
        <span class="kd">synchronized</span><span class="o">(</span><span class="nc">SomeClass</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
            <span class="c1">//code</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_для_чего_используется_ключевое_слово_volatile_synchronized_transient_native">28. Для чего используется ключевое слово <code>volatile</code>, <code>synchronized</code>, <code>transient</code>, <code>native</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong><code>volatile</code></strong> - этот модификатор вынуждает потоки отключить оптимизацию доступа и использовать единственный экземпляр переменной. Если переменная примитивного типа – этого будет достаточно для обеспечения потокобезопасности. Если же переменная является ссылкой на объект – синхронизировано будет исключительно значение этой ссылки. Все же данные, содержащиеся в объекте, синхронизированы не будут!</p>
</div>
<div class="paragraph">
<p><strong><code>synchronized</code></strong> - это зарезервированное слово позволяет добиваться синхронизации в помеченных им методах или блоках кода.</p>
</div>
<div class="paragraph">
<p>Ключевые слова <code>transient</code> и <code>native</code> к многопоточности никакого отношения не имеют, первое используется для указания полей класса, которые не нужно сериализовать, а второе - сигнализирует о том, что метод реализован в платформо-зависимом коде.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_в_чём_различия_между_volatile_и_atomic_переменными">29. В чём различия между <code>volatile</code> и <em>Atomic</em> переменными?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>volatile</code> принуждает использовать единственный экземпляр переменной, но не гарантирует атомарность. Например, операция <code>count++</code> не станет атомарной просто потому, что <code>count</code> объявлена <code>volatile</code>. C другой стороны <code>class AtomicInteger</code> предоставляет атомарный метод для выполнения таких комплексных операций атомарно, например <code>getAndIncrement()</code> – атомарная замена оператора инкремента, его можно использовать, чтобы атомарно увеличить текущее значение на один. Похожим образом сконструированы атомарные версии и для других типов данных.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_в_чём_заключаются_различия_между_java_util_concurrent_atomic_compareandswap_и_java_util_concurrent_atomic_weakcompareandswap">30. В чём заключаются различия между <code>java.util.concurrent.Atomic*.compareAndSwap()</code> и <code>java.util.concurrent.Atomic*.weakCompareAndSwap()</code>.</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><code>weakCompareAndSwap()</code> не создает <em>memory barrier</em> и не дает гарантии <em>happens-before</em>;</p>
</li>
<li>
<p><code>weakCompareAndSwap()</code> сильно зависит от кэша/CPU, и может возвращать <code>false</code> без видимых причин;</p>
</li>
<li>
<p><code>weakCompareAndSwap()</code>, более легкая, но поддерживаемая далеко не всеми архитектурами и не всегда эффективная операция.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_значит_приоритет_потока">31. Что значит <em>«приоритет потока»</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Приоритеты потоков используются планировщиком потоков для принятия решений о том, когда какому из потоков будет разрешено работать. Теоретически высокоприоритетные потоки получают больше времени процессора, чем низкоприоритетные. Практически объем времени процессора, который получает поток, часто зависит от нескольких факторов помимо его приоритета.</p>
</div>
<div class="paragraph">
<p>Чтобы установить приоритет потока, используется метод класса <code>Thread</code>: <code>final void setPriority(int level)</code>. Значение <code>level</code> изменяется в пределах от <code>Thread.MIN_PRIORITY = 1</code> до <code>Thread.MAX_PRIORITY = 10</code>. Приоритет по умолчанию - <code>Thread.NORM_PRlORITY = 5</code>.</p>
</div>
<div class="paragraph">
<p>Получить текущее значение приоритета потока можно вызвав метод: <code>final int getPriority()</code> у экземпляра класса <code>Thread</code>.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_потоки_демоны">32. Что такое <em>«потоки-демоны»</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Потоки-демоны работают в фоновом режиме вместе с программой, но не являются неотъемлемой частью программы. Если какой-либо процесс может выполняться на фоне работы основных потоков выполнения и его деятельность заключается в обслуживании основных потоков приложения, то такой процесс может быть запущен как поток-демон с помощью метода <code>setDaemon(boolean value)</code>, вызванного у потока до его запуска. Метод <code>boolean isDaemon()</code> позволяет определить, является ли указанный поток демоном или нет. Базовое свойство потоков-демонов заключается в возможности основного потока приложения завершить выполнение потока-демона (в отличие от обычных потоков) с окончанием кода метода <code>main()</code>, не обращая внимания на то, что поток-демон еще работает.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_можно_ли_сделать_основной_поток_программы_демоном">33. Можно ли сделать основной поток программы демоном?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Нет. Потоки-демоны позволяют описывать фоновые процессы, которые нужны только для обслуживания основных потоков выполнения и не могут существовать без них.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_значит_усыпить_поток">34. Что значит <em>«усыпить»</em> поток?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Это значит приостановить его на определенный промежуток времени, вызвав в ходе его выполнения статический метод <code>Thread.sleep()</code> передав в качестве параметра необходимое количество времени в миллисекундах. До истечения этого времени поток может быть выведен из состояния ожидания вызовом <code>interrupt()</code> с выбрасыванием <code>InterruptedException</code>.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_чем_отличаются_два_интерфейса_runnable_и_callable">35. Чем отличаются два интерфейса <code>Runnable</code> и <code>Callable</code>?</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Интерфейс <code>Runnable</code> появился в Java 1.0, а интерфейс <code>Callable</code> был введен в Java 5.0 в составе библиотеки <code>java.util.concurrent</code>;</p>
</li>
<li>
<p>Классы, реализующие интерфейс <code>Runnable</code> для выполнения задачи должны реализовывать метод <code>run()</code>. Классы, реализующие интерфейс <code>Callable</code> - метод <code>call()</code>;</p>
</li>
<li>
<p>Метод <code>Runnable.run()</code> не возвращает никакого значения, <code>Callable.call()</code> возвращает объект <code>Future</code>, который может содержать результат вычислений;</p>
</li>
<li>
<p>Метод <code>run()</code> не может выбрасывать проверяемые исключения, в то время как метод <code>call()</code> может.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_futuretask">36. Что такое <code>FutureTask</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>FutureTask</code> представляет собой отменяемое асинхронное вычисление в параллельном Java приложении. Этот класс предоставляет базовую реализацию <code>Future</code>, с методами для запуска и остановки вычисления, методами для запроса состояния вычисления и извлечения результатов. Результат может быть получен только когда вычисление завершено, метод получения будет заблокирован, если вычисление ещё не завершено. Объекты <code>FutureTask</code> могут быть использованы для обёртки объектов <code>Callable</code> и <code>Runnable</code>. Так как <code>FutureTask</code> реализует <code>Runnable</code>, его можно передать в <code>Executor</code> на выполнение.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_в_чем_заключаются_различия_между_cyclicbarrier_и_countdownlatch">37. В чем заключаются различия между <code>CyclicBarrier</code> и <code>CountDownLatch</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>CountDownLatch</code> (замок с обратным отсчетом) предоставляет возможность любому количеству потоков в блоке кода ожидать до тех пор, пока не завершится определенное количество операций, выполняющихся в других потоках, перед тем как они будут «отпущены», чтобы продолжить свою деятельность. В конструктор <code>CountDownLatch(int count)</code> обязательно передается количество операций, которое должно быть выполнено, чтобы замок «отпустил» заблокированные потоки.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Примером <code>CountDownLatch</code> из жизни может служить сбор экскурсионной группы: пока не наберется определенное количество человек, экскурсия не начнется.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><code>CyclicBarrier</code> реализует шаблон синхронизации «Барьер». Циклический барьер является точкой синхронизации, в которой указанное количество параллельных потоков встречается и блокируется. Как только все потоки прибыли, выполняется опционное действие (или не выполняется, если барьер был инициализирован без него), и, после того, как оно выполнено, барьер ломается и ожидающие потоки «освобождаются». В конструкторы барьера <code>CyclicBarrier(int parties)</code> и <code>CyclicBarrier(int parties, Runnable barrierAction)</code> обязательно передается количество сторон, которые должны «встретиться», и, опционально, действие, которое должно произойти, когда стороны встретились, но перед тем когда они будут «отпущены».</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><code>CyclicBarrier</code> является альтернативой метода <code>join()</code>, который «собирает» потоки только после того, как они выполнились.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><code>CyclicBarrier</code> похож на <code>CountDownLatch</code>, но главное различие между ними в том, что использовать «замок» можно лишь единожды - после того, как его счётчик достигнет нуля, а «барьер» можно использовать неоднократно, даже после того, как он «сломается».</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_race_condition">38. Что такое <em>race condition</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Состояние гонки</strong> (race condition) - ошибка проектирования многопоточной системы или приложения, при которой эта работа напрямую зависит от того, в каком порядке выполняются потоки. Состояние гонки возникает, когда поток, который должен исполнится в начале, проиграл гонку и первым исполняется другой поток: поведение кода изменяется, из-за чего возникают недетерменированные ошибки.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_существует_ли_способ_решения_проблемы_race_condition">39. Существует ли способ решения проблемы <em>race condition</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Распространённые способы решения:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Использование локальной копии</strong> — копирование разделяемой переменной в локальную переменную потока. Этот способ работает только тогда, когда переменная одна и копирование производится атомарно (за одну машинную команду), использование <code>volatile</code>.</p>
</li>
<li>
<p><strong>Синхронизация</strong> - операции над разделяемым ресурсом происходят в синхронизированном блоке (при использовании ключевого слова <code>synchronized</code>).</p>
</li>
<li>
<p><strong>Комбинирование методов</strong> - вышеперечисленные способы можно комбинировать, копируя «опасные» переменные в синхронизированном блоке. С одной стороны, это снимает ограничение на атомарность, с другой — позволяет избавиться от слишком больших синхронизированных блоков.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Очевидных способов выявления и исправления состояний гонки не существует. Лучший способ избавиться от гонок — правильное проектирование многозадачной системы.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_как_остановить_поток">40. Как остановить поток?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>На данный момент в Java принят уведомительный порядок остановки потока (хотя JDK 1.0 и имеет несколько управляющих выполнением потока методов, например <code>stop()</code>, <code>suspend()</code> и <code>resume()</code> - в следующих версиях JDK все они были помечены как <code>deprecated</code> из-за потенциальных угроз взаимной блокировки).</p>
</div>
<div class="paragraph">
<p>Для корректной остановки потока можно использовать метод класса <code>Thread</code> - <code>interrupt()</code>. Этот метод выставляет некоторый внутренний флаг-статус прерывания. В дальнейшем состояние этого флага можно проверить с помощью метода <code>isInterrupted()</code> или <code>Thread.interrupted()</code> (для текущего потока). Метод <code>interrupt()</code> также способен вывести поток из состояния ожидания или спячки. Т.е. если у потока были вызваны методы <code>sleep()</code> или <code>wait()</code> – текущее состояние прервется и будет выброшено исключение <code>InterruptedException</code>. Флаг в этом случае не выставляется.</p>
</div>
<div class="paragraph">
<p>Схема действия при этом получается следующей:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Реализовать поток.</p>
</li>
<li>
<p>В потоке периодически проводить проверку статуса прерывания через вызов <code>isInterrupted()</code>.</p>
</li>
<li>
<p>Если состояние флага изменилось или было выброшено исключение во время ожидания/спячки, следовательно поток пытаются остановить извне.</p>
</li>
<li>
<p>Принять решение – продолжить работу (если по каким-то причинам остановиться невозможно) или освободить заблокированные потоком ресурсы и закончить выполнение.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Возможная проблема, которая присутствует в этом подходе – блокировки на потоковом вводе-выводе. Если поток заблокирован на чтении данных - вызов <code>interrupt()</code> из этого состояния его не выведет. Решения тут различаются в зависимости от типа источника данных. Если чтение идет из файла – долговременная блокировка крайне маловероятна и тогда можно просто дождаться выхода из метода <code>read()</code>. Если же чтение каким-то образом связано с сетью – стоит использовать неблокирующий ввод-вывод из Java NIO.</p>
</div>
<div class="paragraph">
<p>Второй вариант реализации метода остановки (а также и приостановки) – сделать собственный аналог <code>interrupt()</code>. Т.е. объявить в классе потока флаги – на остановку и/или приостановку и выставлять их путем вызова заранее определённых методов извне. Методика действия при этом остаётся прежней – проверять установку флагов и принимать решения при их изменении. Недостатки такого подхода. Во-первых, потоки в состоянии ожидания таким способом не «оживить». Во-вторых, выставление флага одним потоком совсем не означает, что второй поток тут же его увидит. Для увеличения производительности виртуальная машина использует кеш данных потока, в результате чего обновление переменной у второго потока может произойти через неопределенный промежуток времени (хотя допустимым решением будет объявить переменную-флаг как <code>volatile</code>).</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_почему_не_рекомендуется_использовать_метод_thread_stop">41. Почему не рекомендуется использовать метод <code>Thread.stop()</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>При принудительной остановке (приостановке) потока, <code>stop()</code> прерывает поток в недетерменированном месте выполнения, в результате становится совершенно непонятно, что делать с принадлежащими ему ресурсами. Поток может открыть сетевое соединение - что в таком случае делать с данными, которые еще не вычитаны? Где гарантия, что после дальнейшего запуска потока (в случае приостановки) он сможет их дочитать? Если поток блокировал разделяемый ресурс, то как снять эту блокировку и не переведёт ли принудительное снятие к нарушению консистентности системы? То же самое можно расширить и на случай соединения с базой данных: если поток остановят посередине транзакции, то кто ее будет закрывать? Кто и как будет разблокировать ресурсы?</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_происходит_когда_в_потоке_выбрасывается_исключение">42. Что происходит, когда в потоке выбрасывается исключение?</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Если исключение не поймано – поток «умирает» (переходит в состяние мёртв (dead)).</p>
</li>
<li>
<p>Если установлен обработчик непойманных исключений, то он возьмёт управление на себя. <code>Thread.UncaughtExceptionHandler</code> – интерфейс, определённый как вложенный интерфейс для других обработчиков, вызываемых, когда поток внезапно останавливается из-за непойманного исключения. В случае, если поток собирается остановиться из-за непойманного исключения, JVM проверяет его на наличие <code>UncaughtExceptionHandler</code>, используя <code>Thread.getUncaughtExceptionHandler()</code>, и если такой обработчик найдет, то вызовет у него метод <code>uncaughtException()</code>, передав этот поток и исключение в виде аргументов.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_в_чем_разница_между_interrupted_и_isinterrupted">43. В чем разница между <code>interrupted()</code> и <code>isInterrupted()</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Механизм прерывания работы потока в Java реализован с использованием внутреннего флага, известного как статус прерывания. Прерывание потока вызовом <code>Thread.interrupt()</code> устанавливает этот флаг. Методы <code>Thread.interrupted()</code> и <code>isInterrupted()</code> позволяют проверить, является ли поток прерванным.</p>
</div>
<div class="paragraph">
<p>Когда прерванный поток проверяет статус прерывания, вызывая статический метод <code>Thread.interrupted()</code>, статус прерывания сбрасывается.</p>
</div>
<div class="paragraph">
<p>Нестатический метод <code>isInterrupted()</code> используется одним потоком для проверки статуса прерывания у другого потока, не изменяя флаг прерывания.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_пул_потоков">44. Что такое <em>«пул потоков»</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Создание потока является затратной по времени и ресурсам операцией. Количество потоков, которое может быть запущено в рамках одного процесса также ограниченно. Чтобы избежать этих проблем и в целом управлять множеством потоков более эффективно в Java был реализован механизм пула потоков (thread pool), который создаётся во время запуска приложения и в дальнейшем потоки для обработки запросов берутся и переиспользуются уже из него. Таким образом, появляется возможность не терять потоки, сбалансировать приложение по количеству потоков и частоте их создания.</p>
</div>
<div class="paragraph">
<p>Начиная с Java 1.5 Java API предоставляет фреймворк <code>Executor</code>, который позволяет создавать различные типы пула потоков:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Executor</code> - упрощенный интерфейс пула, содержит один метод для передачи задачи на выполнение;</p>
</li>
<li>
<p><code>ExecutorService</code> - расширенный интерфейс пула, с возможностью завершения всех потоков;</p>
</li>
<li>
<p><code>AbstractExecutorService</code> - базовый класс пула, реализующий интерфейс <code>ExecutorService</code>;</p>
</li>
<li>
<p><code>Executors</code> - фабрика объектов связанных с пулом потоков, в том числе позволяет создать основные типы пулов;</p>
</li>
<li>
<p><code>ThreadPoolExecutor</code> - пул потоков с гибкой настройкой, может служить базовым классом для нестандартных пулов;</p>
</li>
<li>
<p><code>ForkJoinPool</code> - пул для выполнения задач типа <code>ForkJoinTask</code>;</p>
</li>
<li>
<p>… и другие.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Методы <code>Executors</code> для создания пулов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>newCachedThreadPool()</code> - если есть свободный поток, то задача выполняется в нем, иначе добавляется новый поток в пул. Потоки не используемые больше минуты завершаются и удалются и кэша. Размер пула неограничен. Предназначен для выполнения множество небольших асинхронных задач;</p>
</li>
<li>
<p><code>newCachedThreadPool(ThreadFactory threadFactory)</code> - аналогично предыдущему, но с собственной фабрикой потоков;</p>
</li>
<li>
<p><code>newFixedThreadPool(int nThreads)</code> - создает пул на указанное число потоков. Если новые задачи добавлены, когда все потоки активны, то они будут сохранены в очереди для выполнения позже. Если один из потоков завершился из-за ошибки, на его место будет запущен другой поток. Потоки живут до тех пор, пока пул не будет закрыт явно методом <code>shutdown()</code>.</p>
</li>
<li>
<p><code>newFixedThreadPool(int nThreads, ThreadFactory threadFactory)</code> - аналогично предыдущему, но с собственной фабрикой потоков;</p>
</li>
<li>
<p><code>newSingleThreadScheduledExecutor()</code> - однопотоковый пул с возможностью выполнять задачу через указанное время или выполнять периодически. Если поток был завершен из-за каких-либо ошибок, то для выполнения следующей задачи будет создан новый поток.</p>
</li>
<li>
<p><code>newSingleThreadScheduledExecutor(ThreadFactory threadFactory)</code> - аналогично предыдущему, но с собственной фабрикой потоков;</p>
</li>
<li>
<p><code>newScheduledThreadPool(int corePoolSize)</code> - пул для выполнения задач через указанное время или переодически;</p>
</li>
<li>
<p><code>newScheduledThreadPool(int corePoolSize, ThreadFactory threadFactory)</code> - аналогично предыдущему, но с собственной фабрикой потоков;</p>
</li>
<li>
<p><code>unconfigurableExecutorService(ExecutorService executor)</code> - обертка на пул, запрещающая изменять его конфигурацию;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_какого_размера_должен_быть_пул_потоков">45. Какого размера должен быть пул потоков?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Настраивая размер пула потоков, важно избежать двух ошибок: слишком мало потоков (очередь на выполнение будет расти, потребляя много памяти) или слишком много потоков (замедление работы всей систему из-за частых переключений контекста).</p>
</div>
<div class="paragraph">
<p>Оптимальный размер пула потоков зависит от количества доступных процессоров и природы задач в рабочей очереди. На N-процессорной системе для рабочей очереди, которая будет выполнять исключительно задачи с ограничением по скорости вычислений, можно достигнуть максимального использования CPU с пулом потоков, в котором содержится N или N+1 поток.
Для задач, которые могут ждать осуществления I/O (ввода - вывода) - например, задачи, считывающей HTTP-запрос из сокета – может понадобиться увеличение размера пула свыше количества доступных процессоров, потому, что не все потоки будут работать все время. Используя профилирование, можно оценить отношение времени ожидания (<code>WT</code>) ко времени обработки (<code>ST</code>) для типичного запроса. Если назвать это соотношение <code>WT/ST</code>, то для N-процессорной системе понадобится примерно <code>N*(1 + WT/ST)</code> потоков для полной загруженности процессоров.</p>
</div>
<div class="paragraph">
<p>Использование процессора – не единственный фактор, важный при настройке размера пула потоков. По мере возрастания пула потоков, можно столкнуться с ограничениями планировщика, доступной памяти, или других системных ресурсов, таких, как количество сокетов, дескрипторы открытого файла, или каналы связи базы данных.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_будет_если_очередь_пула_потоков_уже_заполнена_но_подаётся_новая_задача">46. Что будет, если очередь пула потоков уже заполнена, но подаётся новая задача?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Если очередь пула потоков заполнилась, то поданная задача будет «отклонена». Например - метод <code>submit()</code> у <code>ThreadPoolExecutor</code> выкидывает <code>RejectedExecutionException</code>, после которого вызывается <code>RejectedExecutionHandler</code>.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_в_чём_заключается_различие_между_методами_submit_и_execute_у_пула_потоков">47. В чём заключается различие между методами <code>submit()</code> и <code>execute()</code> у пула потоков?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Оба метода являются способами подачи задачи в пул потоков, но между ними есть небольшая разница.</p>
</div>
<div class="paragraph">
<p><code>execute(Runnable command)</code> определён в интерфейсе <code>Executor</code> и выполняет поданную задачу и ничего не возвращает.</p>
</div>
<div class="paragraph">
<p><code>submit()</code> – перегруженный метод, определённый в интерфейсе <code>ExecutorService</code>. Способен принимать задачи типов <code>Runnable</code> и <code>Callable</code> и возвращать объект <code>Future</code>, который можно использовать для контроля и управления процессом выполнения, получения его результата.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_в_чем_заключаются_различия_между_cтеком_stack_и_кучей_heap_с_точки_зрения_многопоточности">48. В чем заключаются различия между cтеком (stack) и кучей (heap) с точки зрения многопоточности?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Cтек</strong> – участок памяти, тесно связанный с потоками. У каждого потока есть свой стек, которые хранит локальные переменные, параметры методов и стек вызовов. Переменная, хранящаяся в стеке одного потока, не видна для другого.</p>
</div>
<div class="paragraph">
<p><strong>Куча</strong> – общий участок памяти, который делится между всеми потоками. Объекты, неважно локальные или любого другого уровня, создаются в куче. Для улучшения производительности, поток обычно кэширует значения из кучи в свой стек, в этом случае для того, чтобы указать потоку, что переменную следует читать из кучи используется ключевое слово <code>volatile</code>.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_как_поделиться_данными_между_двумя_потоками">49. Как поделиться данными между двумя потоками?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Данными между потоками возможно делиться, используя общий объект или параллельные структуры данных, например <code>BlockingQueue</code>.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_какой_параметр_запуска_jvm_используется_для_контроля_размера_стека_потока">50. Какой параметр запуска JVM используется для контроля размера стека потока?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>-Xss</code></p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_как_получить_дамп_потока">51. Как получить дамп потока?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Среды исполнения Java на основе HotSpot генерируют только дамп в формате HPROF. В распоряжении разработчика имеется несколько интерактивных методов генерации дампов и один метод генерации дампов на основе событий.</p>
</div>
<div class="paragraph">
<p>Интерактивные методы:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Использование &lt;kbd&gt;Ctrl+Break&lt;/kbd&gt;: если для исполняющегося приложения установлена опция командной строки <code>-XX:+HeapDumpOnCtrlBreak</code>, то дамп формата HPROF генерируется вместе с дампом потока при наступлении события <code>Ctrl+Break</code> или <code>SIGQUIT</code> (обычно генерируется с помощью <em>kill -3</em>), которое инициируется посредством консоли. Эта опция может быть недоступна в некоторых версиях. В этом случае можно попытаться использовать следующую опцию:
<code>-Xrunhprof:format=b,file=heapdump.hprof</code></p>
</li>
<li>
<p>Использование инструмента <em>jmap</em>: утилита <em>jmap</em>, поставляемая в составе каталога <code>/bin/</code> комплекта JDK, позволяет запрашивать дамп HPROF из исполняющегося процесса.</p>
</li>
<li>
<p>Использование операционной системы: Для создания файла ядра можно воспользоваться неразрушающей командой <em>gcore</em> или разрушающими командами <em>kill -6</em> или <em>kill -11</em>. Затем извлечь дамп кучи из файла ядра с помощью утилиты <em>jmap</em>.</p>
</li>
<li>
<p>Использование инструмента <em>JConsole</em>. Операция <code>dumpHeap</code> предоставляется в <em>JConsole</em> как MBean-компонент <code>HotSpotDiagnostic</code>. Эта операция запрашивает генерацию дампа в формате HPROF.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Метод на основе событий:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Событие <code>OutOfMemoryError</code>: Если для исполняющегося приложения установлена опция командной строки <code>-XX:+HeapDumpOnOutOfMemoryError</code>, то при возникновении ошибки <code>OutOfMemoryError</code> генерируется дамп формата HPROF. Это идеальный метод для «production» систем, поскольку он практически обязателен для диагностирования проблем памяти и не сопровождается постоянными накладными расходами с точки зрения производительности. В старых выпусках сред исполнения Java на базе HotSpot для этого события не устанавливается предельное количество дампов кучи в пересчете на одну JVM; в более новых выпусках допускается не более одного дампа кучи для этого события на каждый запуск JVM.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_threadlocal_переменная">52. Что такое <em>ThreadLocal-переменная</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>ThreadLocal</code> - класс, позволяющий имея одну переменную, иметь различное её значение для каждого из потоков.</p>
</div>
<div class="paragraph">
<p>У каждого потока - т.е. экземпляра класса <code>Thread</code> - есть ассоциированная с ним таблица <em>ThreadLocal-переменных</em>. Ключами таблицы являются cсылки на объекты класса <code>ThreadLocal</code>, а значениями - ссылки на объекты, «захваченные» ThreadLocal-переменными, т.е. ThreadLocal-переменные отличаются от обычных переменных тем, что у каждого потока свой собственный, индивидуально инициализируемый экземпляр переменной. Доступ к значению можно получить через методы <code>get()</code> или <code>set()</code>.</p>
</div>
<div class="paragraph">
<p>Например, если мы объявим ThreadLocal-переменную: <code>ThreadLocal&lt;Object&gt; locals = new ThreadLocal&lt;Object&gt;();</code>. А затем, в потоке, сделаем <code>locals.set(myObject)</code>, то ключом таблицы будет ссылка на объект <code>locals</code>, а значением - ссылка на объект <code>myObject</code>. При этом для другого потока существует возможность «положить» внутрь <code>locals</code> другое значение.</p>
</div>
<div class="paragraph">
<p>Следует обратить внимание, что <code>ThreadLocal</code> изолирует именно ссылки на объекты, а не сами объекты. Если изолированные внутри потоков ссылки ведут на один и тот же объект, то возможны коллизии.</p>
</div>
<div class="paragraph">
<p>Так же важно отметить, что т.к. ThreadLocal-переменные изолированы в потоках, то инициализация такой переменной должна происходить в том же потоке, в котором она будет использоваться. Ошибкой является инициализация такой переменной (вызов метода <code>set()</code>) в главном потоке приложения, потому как в данном случае значение, переданное в методе <code>set()</code>, будет «захвачено» для главного потока, и при вызове метода <code>get()</code> в целевом потоке будет возвращен <code>null</code>.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_назовите_различия_между_synchronized_и_reentrantlock">53. Назовите различия между <code>synchronized</code> и <code>ReentrantLock</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>В Java 5 появился интерфейс <code>Lock</code> предоставляющий возможности более эффективного и тонкого контроля блокировки ресурсов. <code>ReentrantLock</code> – распространённая реализация <code>Lock</code>, которая предоставляет <code>Lock</code> с таким же базовым поведением и семантикой, как у <code>synchronized</code>, но расширенными возможностями, такими как опрос о блокировании (lock polling), ожидание блокирования заданной длительности и прерываемое ожидание блокировки. Кроме того, он предлагает гораздо более высокую эффективность функционирования в условиях жесткой <em>состязательности</em>.</p>
</div>
<div class="paragraph">
<p>Что понимается под блокировкой с повторным входом (reentrant)? Просто то, что есть подсчет сбора данных, связанный с блокировкой, и если поток, который удерживает блокировку, снова ее получает, данные отражают увеличение, и тогда для реального разблокирования нужно два раза снять блокировку. Это аналогично семантике synchronized; если поток входит в синхронный блок, защищенный монитором, который уже принадлежит потоку, потоку будет разрешено дальнейшее функционирование, и блокировка не будет снята, когда поток выйдет из второго (или последующего) блока synchronized, она будет снята только когда он выйдет из первого блока synchronized, в который он вошел под защитой монитора.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>

<span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="c1">// update object state</span>
<span class="o">}</span>
<span class="k">finally</span> <span class="o">{</span>
  <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Реализация <code>ReentrantLock</code> гораздо более масштабируема в условиях состязательности, чем реализация <code>synchronized</code>. Это значит, что когда много потоков соперничают за право получения блокировки, общая пропускная способность обычно лучше у <code>ReentrantLock</code>, чем у <code>synchronized</code>. JVM требуется меньше времени на установление очередности потоков и больше времени на непосредственно выполнение.</p>
</li>
<li>
<p>У <code>ReentrantLock</code> (как и у других реализаций <code>Lock</code>) блокировка должна обязательно сниматься в <code>finally</code> блоке (иначе, если бы защищенный код выбросил исключение, блокировка не была бы снята). Используя синхронизацию, JVM гарантирует, что блокировка автоматически снимаются.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Резюмируя, можно сказать, что когда состязания за блокировку нет либо оно очень мало, то <code>synchronized</code> возможно будет быстрее. Если присутствует заметное состязание за доступ к ресурсу, то скорее всего <code>ReentrantLock</code> даст некое преимущество.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_readwritelock">54. Что такое <code>ReadWriteLock</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>ReadWriteLock</code> – это интерфейс расширяющий базовый интерфейс <code>Lock</code>. Используется для улучшения производительности в многопоточном процессе и оперирует парой связанных блокировок (одна - для операций чтения, другая - для записи). Блокировка чтения может удерживаться одновременно несколькими читающими потоками, до тех пор, пока не появится записывающий. Блокировка записи является эксклюзивеной.</p>
</div>
<div class="paragraph">
<p>Существует реализующий интерфейс <code>ReadWriteLock</code> класс <code>ReentrantReadWriteLock</code>, который поддерживает до 65535 блокировок записи и до стольки же блокировок чтения.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">ReadWriteLock</span> <span class="n">rwLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">();</span>
<span class="nc">Lock</span> <span class="n">rLock</span> <span class="o">=</span> <span class="n">rwLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">();</span>
<span class="nc">Lock</span> <span class="n">wLock</span> <span class="o">=</span> <span class="n">rwLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">();</span>

<span class="n">wLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="c1">// exclusive write</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">wLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
<span class="o">}</span>

<span class="n">rLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="c1">// shared reading</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">rLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_блокирующий_метод">55. Что такое <em>«блокирующий метод»</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Блокирующий метод</strong> – метод, который блокируется, до тех пор, пока задание не выполнится, например метод <code>accept()</code> у <code>ServerSocket</code> блокируется в ожидании подключения клиента. Здесь блокирование означает, что контроль не вернётся к вызывающему методу до тех пор, пока не выполнится задание. Так же существуют асинхронные или неблокирующиеся методы, которые могут завершится до выполнения задачи.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_фреймворк_forkjoin">56. Что такое <em>«фреймворк Fork/Join»</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Фреймворк Fork/Join, представленный в JDK 7, - это набор классов и интерфейсов позволяющих использовать преимущества многопроцессорной архитектуры современных компьютеров. Он разработан для выполнения задач, которые можно рекурсивно разбить на маленькие подзадачи, которые можно решать параллельно.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Этап Fork: большая задача разделяется на несколько меньших подзадач, которые в свою очередь также разбиваются на меньшие. И так до тех пор, пока задача не становится тривиальной и решаемой последовательным способом.</p>
</li>
<li>
<p>Этап Join: далее (опционально) идёт процесс «свёртки» - решения подзадач некоторым образом объединяются пока не получится решение всей задачи.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Решение всех подзадач (в т.ч. и само разбиение на подзадачи) происходит параллельно.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Для решения некоторых задач этап Join не требуется. Например, для параллельного QuickSort — массив рекурсивно делится на всё меньшие и меньшие диапазоны, пока не вырождается в тривиальный случай из 1 элемента. Хотя в некотором смысле Join будет необходим и тут, т.к. всё равно остаётся необходимость дождаться пока не закончится выполнение всех подзадач.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Ещё одно замечательное преимущество этого фреймворка заключается в том, что он использует work-stealing алгоритм: потоки, которые завершили выполнение собственных подзадач, могут «украсть» подзадачи у других потоков, которые всё ещё заняты.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_semaphore">57. Что такое <code>Semaphore</code>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Semaphore – это новый тип синхронизатора: семафор со счётчиком, реализующий шаблон синхронизации Семафор. Доступ управляется с помощью счётчика: изначальное значение счётчика задаётся в конструкторе при создании синхронизатора, когда поток заходит в заданный блок кода, то значение счётчика уменьшается на единицу, когда поток его покидает, то увеличивается. Если значение счётчика равно нулю, то текущий поток блокируется, пока кто-нибудь не выйдет из защищаемого блока. Semaphore используется для защиты дорогих ресурсов, которые доступны в ограниченном количестве, например подключение к базе данных в пуле.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_double_checked_locking_singleton">58. Что такое <em>double checked locking Singleton</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>double checked locking Singleton</strong> - это один из способов создания потокобезопасного класса реализующего шаблон Одиночка. Данный метод пытается оптимизировать производительность, блокируясь только случае, когда экземпляр одиночки создаётся впервые.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">DoubleCheckedLockingSingleton</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">DoubleCheckedLockingSingleton</span> <span class="n">instance</span><span class="o">;</span>

    <span class="kd">static</span> <span class="nc">DoubleCheckedLockingSingleton</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DoubleCheckedLockingSingleton</span> <span class="n">current</span> <span class="o">=</span> <span class="n">instance</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">DoubleCheckedLockingSingleton</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">instance</span><span class="o">;</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">instance</span> <span class="o">=</span> <span class="n">current</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DoubleCheckedLockingSingleton</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">current</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Следует заметить, что требование <code>volatile</code> обязательно. Проблема Double Checked Lock заключается в модели памяти Java, точнее в порядке создания объектов, когда возможна ситуация, при которой другой поток может получить и начать использовать (на основании условия, что указатель не нулевой) не полностью сконструированный объект. Хотя эта проблема была частично решена в JDK 1.5, однако рекомендация использовать <code>volatile</code> для Double Cheсked Lock остаётся в силе.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_как_создать_потокобезопасный_singleton">59. Как создать потокобезопасный Singleton?</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><strong>Static field</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>public class Singleton {
	public static final Singleton INSTANCE = new Singleton();
}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Enum</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>public enum Singleton {
	INSTANCE;
}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Synchronized Accessor</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>public class Singleton {
	private static Singleton instance;

	public static synchronized Singleton getInstance() {
		if (instance == null) {
			instance = new Singleton();
		}
		return instance;
	}
}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Double Checked Locking &amp; <code>volatile</code></strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>public class Singleton {
        private static volatile Singleton instance;

        public static Singleton getInstance() {
		Singleton localInstance = instance;
		if (localInstance == null) {
			synchronized (Singleton.class) {
				localInstance = instance;
				if (localInstance == null) {
					instance = localInstance = new Singleton();
				}
			}
		}
		return localInstance;
	}
}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>On Demand Holder Idiom</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>public class Singleton {

	public static class SingletonHolder {
		public static final Singleton HOLDER_INSTANCE = new Singleton();
	}

	public static Singleton getInstance() {
		return SingletonHolder.HOLDER_INSTANCE;
	}
}</pre>
</div>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_чем_полезны_неизменяемые_объекты">60. Чем полезны неизменяемые объекты?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Неизменяемость (immutability) помогает облегчить написание многопоточного кода. Неизменяемый объект может быть использован без какой-либо синхронизации. К сожалению, в Java нет аннотации <code>@Immutable</code>, которая делает объект неизменяемым, для этого разработчикам нужно самим создавать класс с необходимыми характеристиками. Для этого необходимо следовать некоторым общим принципам: инициализация всех полей только в конструкторе, отсутствие методов <code>setX()</code> вносящих изменения в поля класса, отсутствие утечек ссылки, организация отдельного хранилища копий изменяемых объектов и т.д.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_busy_spin">61. Что такое <em>busy spin</em>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>busy spin</strong> – это техника, которую программисты используют, чтобы заставить поток ожидать при определённом условии. В отличие от традиционных методов <code>wait()</code>, <code>sleep()</code> или <code>yield()</code>, которые подразумевают уступку процессорного времени, этот метод вместо уступки выполняет пустой цикл. Это необходимо, для того, чтобы сохранить кэш процессора, т.к. в многоядерных системах, существует вероятность, что приостановленный поток продолжит своё выполнение уже на другом ядре, а это повлечет за собой перестройку состояния процессорного кэша, которая является достаточно затратной процедурой.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_перечислите_принципы_которым_вы_следуете_в_многопоточном_программировании">62. Перечислите принципы, которым вы следуете в многопоточном программировании?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>При написании многопоточных программ следует придерживаться определённых правил, которые помогают обеспечить достойную производительность приложения в сочетании с удобной отладкой и простотой дальнейшей поддержки кода.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Всегда давайте значимые имена своим потокам. Процесс отладки, нахождения ошибок или отслеживание исключения в многопоточном коде – довольно сложная задача. <code>OrderProcessor</code>, <code>QuoteProcessor</code> или <code>TradeProcessor</code> намного информативнее, чем <code>Thread1</code>, <code>Thread2</code> и <code>Thread3</code>. Имя должно отражать задачу, выполняемую данным потоком.</p>
</li>
<li>
<p>Избегайте блокировок или старайтесь уменьшить масштабы синхронизации. Блокировка затратна, а переключение контекста ещё более ресурсоёмко. Пытайтесь избегать синхронизации и блокировки насколько это возможно, и организуйте критическую секцию в минимально необходимом объёме. Поэтому синхронизированный блок всегда предпочительней синхронизированного метода, дополнительно наделяя возможностью абсолютного контроля над масштабом блокировки.</p>
</li>
<li>
<p>Обрабатывайте прерывание потока с особой тщательностью. Нет ничего хуже оставшегося заблокированным ресурса или системы в неконстистентном, по причине неподтверждённой транзакции, состоянии.</p>
</li>
<li>
<p>Помните об обработке исключений. Выброшенные <code>InterruptedException</code> должны быть адекватно обработаны, а не просто подавлены. Так же не стоит пренебрегать <code>Thread.UncaughtExceptionHandler</code>. При использовании пула потоков необходимо помнить, что он зачастую просто «проглатывает» исключения. Так, если вы отправили на выполнение <code>Runnable</code> нужно обязательно поместить код выполнения задачи внутрь блока <code>try-catch</code>. Если в очередь пула помещается <code>Callable</code>, необходимо удостоверится, что результат выполнения всегда изымается помощью блокирующего <code>get()</code>, чтобы в случае возникновения существовала возможнотсь заново выбросить произошедшее исключение.</p>
</li>
<li>
<p>Между синхронизаторами и <code>wait()</code> и <code>notify()</code> следует выбирать синхронизаторы. Во-первых, синхронизаторы, типа <code>CountDownLatch</code>, <code>Semaphore</code>, <code>CyclicBarrier</code> или <code>Exchanger</code> упрощают написание кода. Очень сложно реализовывать комплексный управляющий поток, используя <code>wait()</code> и <code>notify()</code>. Во-вторых, эти классы написаны и поддерживаются настоящими мастерами своего дела и есть шанс, что в последующих версиях JDK они будут оптимизированы изнутри или заменены более производительной внешней реализацией.</p>
</li>
<li>
<p>Почти всегда использование Concurrent сollection выгоднее использования Synchronized сollection, т.к. первые более современны (используют все доступные на момент их написания новшества языка) и масштабируемы, чем их синхронизированые аналоги.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_какое_из_следующих_утверждений_о_потоках_неверно">63. Какое из следующих утверждений о потоках неверно?</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Если метод <code>start()</code> вызывается дважды для одного и того же объекта <code>Thread</code>, во время выполнения генерируется исключение.</p>
</li>
<li>
<p>Порядок, в котором запускались потоки, может не совпадать с порядком их фактического выполнения.</p>
</li>
<li>
<p>Если метод <code>run()</code> вызывается напрямую для объекта <code>Thread</code>, во время выполнения генерируется исключение.</p>
</li>
<li>
<p>Если метод <code>sleep()</code> вызывается для потока, во время выполнения синхронизированного кода, блокировка не снимается.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Правильный ответ: 3. Если метод <code>run()</code> вызывается напрямую для объекта <code>Thread</code>, во время выполнения исключение не генерируется. Однако, код, написанный в методе <code>run()</code> будет выполняться текущим, а не новым потоком. Таким образом, правильный способ запустить поток – это вызов метода <code>start()</code>, который приводит к выполнению метода <code>run()</code> новым потоком.</p>
</div>
<div class="paragraph">
<p>Вызов метода <code>start()</code> дважды для одного и того же объекта <code>Thread</code> приведёт к генерированию исключения <code>IllegalThreadStateException</code> во время выполнения, следовательно, утверждение 1 верно. Утверждение 2 верно, так как порядок, в котором выполняются потоки, определяется Планировщиком потоков, независимо от того, какой поток запущен первым. Утверждение 4 верно, так как поток не освободит блокировки, которые он держит, когда он переходит в состояние Ожидания.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_даны_3_потока_т1_т2_и_т3_как_реализовать_выполнение_в_последовательности_т1_т2_т3">64. Даны 3 потока Т1, Т2 и Т3? Как реализовать выполнение в последовательности Т1, Т2, Т3?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Такой последовательности выполнения можно достичь многими способами, например просто воспользоваться методом <code>join()</code>, чтобы запустить поток в момент, когда другой уже закончит своё выполнение. Для реализации заданной последовательности, нужно запустить последний поток первым, и затем вызывать метод <code>join()</code> в обратном порядке, то есть Т3 вызывает <code>Т2.join</code>, а Т2 вызывает <code>Т1.join</code>, таким образом Т1 закончит выполнение первым, а Т3 последним.</p>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_напишите_минимальный_неблокирующий_стек_всего_два_метода_push_и_pop">65. Напишите минимальный неблокирующий стек (всего два метода — <code>push()</code> и <code>pop()</code>).</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">NonBlockingStack</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="nc">Element</span><span class="o">&gt;</span> <span class="n">head</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicReference</span><span class="o">&lt;&gt;(</span><span class="kc">null</span><span class="o">);</span>

    <span class="nc">NonBlockingStack</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">push</span><span class="o">(</span><span class="kd">final</span> <span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Element</span> <span class="n">current</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Element</span><span class="o">();</span>
        <span class="n">current</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="nc">Element</span> <span class="n">recent</span><span class="o">;</span>
        <span class="k">do</span> <span class="o">{</span>
            <span class="n">recent</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="n">current</span><span class="o">.</span><span class="na">previous</span> <span class="o">=</span> <span class="n">recent</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">head</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">recent</span><span class="o">,</span> <span class="n">current</span><span class="o">));</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="no">T</span> <span class="nf">pop</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Element</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">Element</span> <span class="n">previous</span><span class="o">;</span>
        <span class="k">do</span> <span class="o">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">previous</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">head</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">previous</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">Element</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="no">T</span> <span class="n">value</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">Element</span> <span class="n">previous</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_напишите_минимальный_неблокирующий_стек_всего_два_метода_push_и_pop_с_использованием_semaphore">66. Напишите минимальный неблокирующий стек (всего два метода — <code>push()</code> и <code>pop()</code>) с использованием <code>Semaphore</code>.</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">SemaphoreStack</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Semaphore</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="kd">private</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">head</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="nc">SemaphoreStack</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">push</span><span class="o">(</span><span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">semaphore</span><span class="o">.</span><span class="na">acquireUninterruptibly</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">head</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="n">value</span><span class="o">,</span> <span class="n">head</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">semaphore</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="no">T</span> <span class="nf">pop</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">semaphore</span><span class="o">.</span><span class="na">acquireUninterruptibly</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="k">return</span> <span class="n">current</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">semaphore</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="no">E</span> <span class="n">value</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nf">Node</span><span class="o">(</span><span class="no">E</span> <span class="n">value</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_напишите_минимальный_неблокирующий_arraylist_всего_четыре_метода_add_get_remove_size">67. Напишите минимальный неблокирующий ArrayList (всего четыре метода — <code>add()</code>, <code>get()</code>, <code>remove()</code>, <code>size()</code>).</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">NonBlockingArrayList</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>

    <span class="nc">NonBlockingArrayList</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">add</span><span class="o">(</span><span class="no">T</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">add</span><span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">item</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">NonBlockingArrayList</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">T</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="kt">boolean</span> <span class="n">needsModification</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">content</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">needsModification</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">item</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">needsModification</span> <span class="o">=</span> <span class="n">content</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">needsModification</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">content</span><span class="o">[</span><span class="n">index</span><span class="o">]);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">needsModification</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">renewed</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="nc">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
            <span class="n">renewed</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">;</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">renewed</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nc">NonBlockingArrayList</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">remove</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">content</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">renewed</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">renewed</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">index</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">renewed</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">index</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">renewed</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="no">T</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">content</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_напишите_потокобезопасную_реализацию_класса_с_неблокирующим_методом_biginteger_next_который_возвращает_элементы_последовательности_1_2_4_8_16">68. Напишите потокобезопасную реализацию класса с неблокирующим методом <code>BigInteger next()</code>, который возвращает элементы последовательности: <code>[1, 2, 4, 8, 16, &#8230;&#8203;]</code>.</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">PowerOfTwo</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="nc">BigInteger</span><span class="o">&gt;</span> <span class="n">current</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicReference</span><span class="o">&lt;&gt;(</span><span class="kc">null</span><span class="o">);</span>

    <span class="nc">BigInteger</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">BigInteger</span> <span class="n">recent</span><span class="o">,</span> <span class="n">next</span><span class="o">;</span>
        <span class="k">do</span> <span class="o">{</span>
            <span class="n">recent</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="n">recent</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="nc">BigInteger</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">:</span> <span class="n">recent</span><span class="o">.</span><span class="na">shiftLeft</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">current</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">recent</span><span class="o">,</span> <span class="n">next</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">next</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_напишите_простейший_многопоточный_ограниченный_буфер_с_использованием_synchronized">69. Напишите простейший многопоточный ограниченный буфер с использованием <code>synchronized</code>.</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">QueueSynchronized</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">content</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">capacity</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">out</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">in</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">isEmpty</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">isFull</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

    <span class="nc">QueueSynchronized</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="k">this</span><span class="o">.</span><span class="na">capacity</span><span class="o">];</span>
        <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">in</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">cycleInc</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(++</span><span class="n">index</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span>
                <span class="o">?</span> <span class="mi">0</span>
                <span class="o">:</span> <span class="n">index</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="no">T</span> <span class="nf">get</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">isEmpty</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">content</span><span class="o">[</span><span class="n">out</span><span class="o">];</span>
                <span class="n">content</span><span class="o">[</span><span class="n">out</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">cycleInc</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">size</span><span class="o">--;</span>
                <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">value</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">isFull</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">isFull</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nc">QueueSynchronized</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">put</span><span class="o">(</span><span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">isFull</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">isFull</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">content</span><span class="o">[</span><span class="n">in</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">in</span> <span class="o">=</span> <span class="n">cycleInc</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
                <span class="n">content</span><span class="o">[</span><span class="n">in</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">size</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">isEmpty</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_напишите_простейший_многопоточный_ограниченный_буфер_с_использованием_reentrantlock">70. Напишите простейший многопоточный ограниченный буфер с использованием <code>ReentrantLock</code>.</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">QueueReentrantLock</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">content</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">capacity</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">out</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">in</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Condition</span> <span class="n">isEmpty</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Condition</span> <span class="n">isFull</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>

    <span class="nc">QueueReentrantLock</span><span class="o">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="k">this</span><span class="o">.</span><span class="na">capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">;</span>
            <span class="n">content</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">capacity</span><span class="o">];</span>
            <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">in</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">cycleInc</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(++</span><span class="n">index</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span>
                <span class="o">?</span> <span class="mi">0</span>
                <span class="o">:</span> <span class="n">index</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="no">T</span> <span class="nf">get</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">isEmpty</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="kd">final</span> <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">content</span><span class="o">[</span><span class="n">out</span><span class="o">];</span>
            <span class="n">content</span><span class="o">[</span><span class="n">out</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">cycleInc</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">size</span><span class="o">--;</span>
            <span class="n">isFull</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
            <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">value</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nc">QueueReentrantLock</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">put</span><span class="o">(</span><span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">isFull</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">content</span><span class="o">[</span><span class="n">in</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">in</span> <span class="o">=</span> <span class="n">cycleInc</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
                <span class="n">content</span><span class="o">[</span><span class="n">in</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">size</span><span class="o">++;</span>
            <span class="n">isEmpty</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#Многопоточность">к оглавлению</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_источники">71. Источники</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://habrahabr.ru/post/164487/">Хабрахабр - Многопоточность в Java</a></p>
</li>
<li>
<p><a href="https://www.ibm.com/developerworks/ru/library/l-java_universe_multithreading_tasks/">IBM DeveloperWorks - Выполнение задач в многопоточном режиме</a></p>
</li>
<li>
<p><a href="http://www.skipy.ru/technics/synchronization.html">Записки трезвого практика</a></p>
</li>
<li>
<p><a href="https://www.ibm.com/developerworks/ru/edu/j-scjp/section8.html">IBM DeveloperWorks - SCJP</a></p>
</li>
<li>
<p><a href="http://info.javarush.ru/KapChook/2015/02/15/Перевод-Топ-50-интервью-вопросов-по-нитям-Часть-1-.html">JavaRush</a></p>
</li>
<li>
<p><a href="https://habrahabr.ru/post/277669/">Хабрахабр - Справочник по синхронизаторам <code>java.util.concurrent.*</code></a></p>
</li>
<li>
<p><a href="http://samolisov.blogspot.ru/2011/04/threadlocal.html">Блог сурового челябинского программиста</a></p>
</li>
<li>
<p><a href="http://www.ibm.com/developerworks/ru/library/j-jtp10264/">"IBM DeveloperWorks - Более гибкая, масштабируемая блокировка в JDK 5.0"</a></p>
</li>
<li>
<p><a href="https://habrahabr.ru/post/129494/">Хабрахабр - Правильный Singleton в Java</a></p>
</li>
<li>
<p><a href="http://www.duct-tape-architect.ru/?p=294#3" class="bare">http://www.duct-tape-architect.ru/?p=294#3</a><em>171_187</em>_Java_HotSpot_JVM6[duct-tape-architect.ru]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="./">Вопросы для собеседования</a></p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-08-04 04:11:55 UTC
</div>
</div>
</body>
</html>